generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "cockroachdb"
    url      = env("DATABASE_URL")
}

model User {
    id         String     @id @default(cuid())
    username   String     @unique
    password   String
    email      String     @unique
    // loginKey    String?
    // loginExpiry DateTime?
    seasons    Season[]
    logs       Log[]
    categories Category[]
    activities Activity[]
}

model Category {
    id          String  @id @default(cuid())
    name        String
    icon        String?
    description String?
    user        User    @relation(fields: [userId], references: [id])
    userId      String
    goals       Goal[]

    @@unique(fields: [userId, name])
}

model Season {
    id           String   @id @default(cuid())
    start        DateTime @default(now())
    length       Int      @default(7862400) // 91 days
    title        String
    description  String?
    levelGoal    Int      @default(100)
    levelMax     Int      @default(120)
    levelXP      Int      @default(10000)
    currentXP    Int      @default(0)
    currentLevel Int      @default(0)
    color1       String?
    color2       String?
    user         User     @relation(fields: [userId], references: [id])
    userId       String
    rewards      Reward[]
    goals        Goal[]

    @@unique([userId, start, length])
}

model Goal {
    id                 String                 @id @default(cuid())
    season             Season                 @relation(fields: [seasonId], references: [id])
    seasonId           String
    category           Category               @relation(fields: [categoryId], references: [id])
    categoryId         String
    lagActivity        ActivityVariationCombo @relation(fields: [lagActivityId], references: [id])
    lagActivityId      String
    lagStartValue      Float
    lagEndValue        Float
    lagProjectionCurve String?
    note               String?
    currentXP          Int                    @default(0)
    seasonXPWeight     Float                  @default(1)
    challenges         Challenge[]

    @@unique([lagActivityId, seasonId])
}

model Challenge {
    id         String                 @id @default(cuid())
    goal       Goal                   @relation(fields: [goalId], references: [id])
    goalId     String
    activity   ActivityVariationCombo @relation(fields: [activityId], references: [id])
    activityId String
    label      String                 @default("{UNIT} of {ACTIVITY}")
    target     Float
    taskXP     Int
    period     String
    isTemplate Boolean                @default(true)
    note       String?

    @@unique([goalId, activityId, target])
}

model Activity {
    id              String                   @id @default(cuid())
    unit            ActivityUnit?            @relation(fields: [unitId], references: [id])
    unitId          String?
    label           String
    isCumulative    Boolean                  @default(true)
    type            String? //primary,secondary,padding
    note            String?
    user            User                     @relation(fields: [userId], references: [id])
    userId          String
    variations      ActivityVariation[]
    variationCombos ActivityVariationCombo[]

    @@unique([userId, label])
}

model Log {
    id         String                 @id @default(cuid())
    user       User                   @relation(fields: [userId], references: [id])
    userId     String
    activity   ActivityVariationCombo @relation(fields: [activityId], references: [id])
    activityId String
    timestamp  DateTime               @default(now())
    value      Float
    note       String?

    @@unique([userId, activityId, timestamp])
}

model Reward {
    id        String  @id @default(cuid())
    season    Season  @relation(fields: [seasonId], references: [id])
    seasonId  String
    label     String
    level     Int
    isClaimed Boolean @default(false)
    note      String?

    @@unique([seasonId, label])
}

model ActivityUnit {
    id       String     @id @default(cuid())
    type     String
    unit     String?
    activity Activity[]

    @@unique(fields: [type, unit])
}

model ActivityVariation {
    id             String                   @id @default(cuid())
    label          String
    activity       Activity                 @relation(fields: [activityId], references: [id])
    activityId     String
    activityCombos ActivityVariationCombo[]

    @@unique(fields: [activityId, label])
}

model ActivityVariationCombo {
    id          String             @id @default(cuid())
    activity    Activity           @relation(fields: [activityId], references: [id])
    activityId  String
    variation   ActivityVariation? @relation(fields: [variationId], references: [id])
    variationId String?
    goals       Goal[]
    logs        Log[]
    challenges  Challenge[]

    @@unique(fields: [activityId, variationId])
}
